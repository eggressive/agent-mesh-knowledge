# v1.1 Improvement: Git Workflow — Branch-per-Task + PRs

**Status:** Implementing  
**Priority:** Critical (prevents merge conflicts)  
**Date:** 2026-02-13

---

## Problem with Current Workflow

**v1.0 approach:** Direct commits to `main`
```bash
git add .
git commit -m "Findings"
git push origin main  # ⚠️ CONFLICT if another agent pushes simultaneously
```

**Issues encountered in Test #3:**
- Race conditions when multiple agents push
- No review/approval process for synthesis
- Hard to track which agent contributed what
- Synthesis merges are invisible

---

## v1.1 Solution: Branch-per-Task + PR Workflow

### New Workflow per Task

```bash
# Step 1: Create task branch from main
git checkout main
git pull origin main
git checkout -b task-2026-02-13-{task-id}
git push origin task-2026-02-13-{task-id}

# Step 2: Each agent creates sub-branch
git checkout -b task-2026-02-13-{task-id}/clawdy
git checkout -b task-2026-02-13-{task-id}/neuromancer

# Step 3: Agents work in isolation
# ... research ...
git add agents/clawdy/findings.md
git commit -m "[RESEARCH-TATOOINE] Task #{id}"
git push origin task-2026-02-13-{task-id}/clawdy

# Step 4: Synthesizer creates synthesis branch
git checkout task-2026-02-13-{task-id}
git checkout -b task-2026-02-13-{task-id}/synthesis

# Step 5: Merge agent findings
git merge task-2026-02-13-{task-id}/clawdy --no-ff
git merge task-2026-02-13-{task-id}/neuromancer --no-ff

# Step 6: Write synthesis
cat > synthesis.md << 'SYNTH'
[SYNTHESIS] Task #{id}
**Contributors:** Clawdy, Neuromancer
**Synthesized by:** {agent-name}
...
SYNTH
git add synthesis.md
git commit -m "[SYNTHESIS] Task #{id}"

# Step 7: Create PR for human review
git push origin task-2026-02-13-{task-id}/synthesis
gh pr create \
  --title "[SYNTHESIS] Task #{id}: {brief description}" \
  --body "Ready for review. Contributors: Clawdy, Neuromancer" \
  --reviewer eggressive \
  --base task-2026-02-13-{task-id}

# Step 8: Human reviews and merges
gh pr merge --squash  # or human clicks merge in GitHub UI
```

---

## Updated File Structure

```
agent-mesh-knowledge/
├── agents/
│   ├── clawdy/
│   │   └── profile.md
│   ├── neuromancer/
│   │   └── profile.md
│   └── moltdude/
│       └── profile.md
├── tasks/
│   └── 2026-02-13-{task-id}/           # Task branch root
│       ├── branches/
│       │   ├── clawdy/                # Clawdy's isolated work
│       │   │   └── findings.md
│       │   ├── neuromancer/           # Neuromancer's isolated work
│       │   │   └── findings.md
│       │   └── moltdude/            # Moltdude's isolated work (future)
│       │       └── findings.md
│       ├── synthesis/               # Merged synthesis (via PR)
│       │   └── synthesis.md
│       └── brief.md                 # Original task description
├── tests/
├── docs/
└── README.md
```

---

## Branch Naming Convention

```
task-{YYYY-MM-DD}-{short-id}/           # Task root branch
├── task-{YYYY-MM-DD}-{short-id}/clawdy      # Agent branches
├── task-{YYYY-MM-DD}-{short-id}/neuromancer
├── task-{YYYY-MM-DD}-{short-id}/moltdude   # (future)
└── task-{YYYY-MM-DD}-{short-id}/synthesis  # Synthesis merge
```

**Examples:**
- `task-2026-02-13-mcp-security/` — Root branch
- `task-2026-02-13-mcp-security/clawdy` — Clawdy's research
- `task-2026-02-13-mcp-security/neuromancer` — Neuromancer's research
- `task-2026-02-13-mcp-security/synthesis` — Final synthesis (PR target)

---

## PR Review Process

### For Human (Mitko)

1. **Notification:** GitHub sends PR review request
2. **Review:** Check synthesis completeness, accuracy, recommendations
3. **Approve:** Click "Approve" or request changes
4. **Merge:** Squash and merge to task branch

### For Agents

```bash
# Check PR status
gh pr view task-2026-02-13-{id}/synthesis

# If human requests changes
git checkout task-2026-02-13-{id}/synthesis
# ... edit ...
git commit -am "Address review feedback"
git push

# Re-request review
gh pr ready
```

---

## Conflict Prevention

**Before (v1.0):** Direct commits → race conditions
```
Clawdy: push main
Neuromancer: push main ← CONFLICT!
```

**After (v1.1):** Isolated branches → no conflicts
```
Clawdy: push task-{id}/clawdy ✓
Neuromancer: push task-{id}/neuromancer ✓
Both: merged in synthesis branch via PR ✓
```

---

## Updated Protocol v1.1

### Step 4: Synthesis (Revised)

**v1.0:**
> Designated agent posts synthesis to Matrix

**v1.1:**
> Designated agent creates synthesis branch, merges agent findings, writes unified synthesis, pushes branch, creates PR for human review

**GitHub CLI commands:**
```bash
# Synthesizer workflow
gh repo clone eggressive/agent-mesh-knowledge
cd agent-mesh-knowledge
git checkout task-{id}
git checkout -b task-{id}/synthesis
git merge task-{id}/clawdy --no-ff
git merge task-{id}/neuromancer --no-ff
# ... write synthesis.md ...
git add synthesis.md
git commit -m "[SYNTHESIS] Task #{id}"
git push origin task-{id}/synthesis
gh pr create --title "[SYNTHESIS]..." --reviewer eggressive
```

---

## Migration from v1.0

**Existing tasks:** Keep in current format (flat structure)
**New tasks:** Use branch-per-task workflow

**Gradual adoption:**
- Week 1-2: Try branch-per-task on 2-3 tasks
- Week 3-4: Evaluate, refine
- Week 5+: Full adoption if successful

---

## Benefits

| Aspect | v1.0 (Direct) | v1.1 (Branch-per-Task) |
|--------|---------------|------------------------|
| **Conflicts** | Common | Eliminated |
| **Review** | None | Human approval required |
| **Traceability** | Hard | Clear branch history |
| **Rollback** | Difficult | Easy (revert PR) |
| **Parallel work** | Risky | Safe isolation |
| **Synthesis quality** | Variable | Reviewed, approved |

---

## Implementation Checklist

- [x] Document branch-per-task workflow
- [x] Update file structure documentation
- [ ] Create `task-template.sh` helper script
- [ ] Update protocol examples with GitHub CLI commands
- [ ] Test on next real task
- [ ] Add branch protection rules to repo settings

---

## Testing the New Workflow

**Test #4: Branch-per-Task Validation** (Proposed)
- Create task branch
- Both agents push to sub-branches
- Synthesizer creates PR
- Human reviews and merges
- Verify: No conflicts, clear history, reviewable synthesis

---

**Status:** Git workflow improvement documented and ready for implementation.

**Next:** Create helper scripts and test on live task.
