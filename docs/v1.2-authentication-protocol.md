# v1.2 Security Enhancement: Authentication & Trust Model
## Message Signing with Public Keys

**Status:** Implementing  
**Priority:** CRITICAL (prevents agent impersonation)  
**Target:** v1.2 release  
**Security Level:** HIGH

---

## The Problem (Current State)

**v1.0-v1.1 vulnerability:** Anyone in the Matrix room can claim to be any agent.

```markdown
# Current message — NO VERIFICATION
[RESEARCH] Neuromancer — Task #5
**Time:** 2026-02-13 10:00 UTC
**Agent:** Neuromancer  ← Anyone can type this

### Findings...
```

**Attack scenarios:**
- Malicious actor joins Matrix room
- Spoofs `[RESEARCH] Clawdy` message with false findings
- Synthesizer incorporates spoofed data into synthesis
- Human receives compromised briefing

**Impact:** HIGH — Synthesis integrity depends on authentic agent contributions

---

## v1.2 Solution: Cryptographic Message Signing

### Core Principle

Every agent message is cryptographically signed with the agent's private key. Other agents verify the signature using the public key from `agents.yaml`.

**Non-repudiation:** Agent cannot deny sending message.  
**Authentication:** Receiver can verify sender identity.  
**Integrity:** Message cannot be tampered with after signing.

---

## Implementation Architecture

### 1. Key Generation (One-time setup per agent)

```bash
# Each agent generates Ed25519 keypair
ssh-keygen -t ed25519 -f ~/.agent-mesh/clawdy_key -C "clawdy@agent-mesh"

# Public key: ~/.agent-mesh/clawdy_key.pub
# Private key: ~/.agent-mesh/clawdy_key (protected, never shared)
```

### 2. Public Key Registry (agents.yaml)

```yaml
# agents.yaml — Extended with public keys
agents:
  clawdy:
    id: clawdy
    name: "Clawdy"
    status: active
    
    authentication:
      method: "ed25519_ssh_key"
      public_key: "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGf... clawdy@agent-mesh"
      key_fingerprint: "SHA256:abc123..."
      last_key_rotation: "2026-02-13"
      
    # ... rest of config
    
  neuromancer:
    id: neuromancer
    name: "Neuromancer"
    status: active
    
    authentication:
      method: "ed25519_ssh_key"
      public_key: "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMx... neuromancer@agent-mesh"
      key_fingerprint: "SHA256:def456..."
      last_key_rotation: "2026-02-13"
```

### 3. Message Signing Protocol

**New message format with signature:**

```markdown
[RESEARCH] Neuromancer — Task #5
**Time:** 2026-02-13 10:00 UTC
**Agent:** neuromancer

### Payload Hash
SHA256: a1b2c3d4e5f6... (hash of message content)

### Findings
1. **CVE-2025-1234** — [finding content]
2. **Vendor pricing** — [finding content]

### Signature
-----BEGIN SSH SIGNATURE-----
U1NIUk9ZLUv... (base64-encoded Ed25519 signature)
-----END SSH SIGNATURE-----

### Verification Command
ssh-keygen -Y verify -f agents.yaml -I neuromancer -n agent-mesh -s message.sig message.txt
```

### 4. Verification Workflow

**When agent receives message:**

```bash
# Step 1: Extract payload and signature
# Step 2: Look up sender's public key in agents.yaml
# Step 3: Verify signature matches public key
# Step 4: Verify payload hash matches content
# Step 5: Only then process the message
```

**Verification script (simplified):**
```python
#!/usr/bin/env python3
"""Verify agent message signature"""

import yaml
import hashlib
import base64
from cryptography.hazmat.primitives import serialization
from cryptography.hazmat.primitives.asymmetric.ed25519 import Ed25519PublicKey

def verify_message(message_file: str, agents_yaml: str) -> bool:
    # Load message
    with open(message_file, 'r') as f:
        content = f.read()
    
    # Parse agent ID from message header
    agent_id = extract_agent_id(content)  # "[RESEARCH] {agent_id}"
    
    # Load public key from agents.yaml
    with open(agents_yaml, 'r') as f:
        config = yaml.safe_load(f)
    
    public_key_str = config['agents'][agent_id]['authentication']['public_key']
    
    # Extract signature from message
    signature = extract_signature(content)
    payload = extract_payload(content)
    
    # Verify signature
    public_key = load_ssh_public_key(public_key_str)
    is_valid = public_key.verify(
        base64.b64decode(signature),
        payload.encode('utf-8')
    )
    
    return is_valid

if __name__ == "__main__":
    import sys
    if len(sys.argv) != 2:
        print("Usage: verify_message.py <message.md>")
        sys.exit(1)
    
    is_valid = verify_message(sys.argv[1], 'agents/agents.yaml')
    print(f"✅ Signature valid" if is_valid else f"❌ Signature INVALID")
    sys.exit(0 if is_valid else 1)
```

---

## Updated Protocol v1.2

### Step 2: Parallel Research (Revised)

**v1.0-v1.1:**
> Conduct research, post findings to Matrix

**v1.2:**
> Conduct research, **sign message with private key**, post to Matrix, other agents **verify signature** before processing

### Communication Syntax Update

| Prefix | v1.0-v1.1 | v1.2 (with authentication) |
|--------|-----------|---------------------------|
| `[RESEARCH]` | Plain message | Signed message + signature block |
| `[SYNTHESIS]` | Plain message | Signed message + signature block |
| `[CONFLICT]` | Plain message | Signed message + signature block |
| `[ACK]` | Plain message | Optional: lightweight signed or unsigned |

**Optional:** `[ACK]` messages can remain unsigned (low security risk), but all `[RESEARCH]`, `[SYNTHESIS]`, `[CONFLICT]` must be signed.

---

## Operational Security

### Key Management

```yaml
# Key rotation schedule (agents.yaml)
authentication:
  public_key: "..."
  key_fingerprint: "SHA256:..."
  last_key_rotation: "2026-02-13"
  next_rotation_due: "2026-08-13"  # 6-month rotation
  rotation_alert_channel: "matrix:@admin:matrix.org"
```

**Key rotation process:**
1. Generate new keypair
2. Update `agents.yaml` with new public key
3. Commit and push to repo
4. Wait for all agents to pull updated config
5. Old key valid for 24-hour grace period
6. Revoke old key

### Compromise Response

**If private key compromised:**
```bash
# Emergency key revocation
# 1. Remove old public key from agents.yaml immediately
# 2. Generate new keypair
# 3. Push emergency update
# 4. Re-sign all recent messages with new key
# 5. Audit: Which messages were signed with compromised key?
```

---

## Migration Path

### Phase 1: Optional Signing (Week 1-2)
- Agents can sign messages but not required
- Backwards compatible with unsigned messages
- Monitor adoption rate

### Phase 2: Required for Research (Week 3-4)
- `[RESEARCH]`, `[SYNTHESIS]`, `[CONFLICT]` must be signed
- `[ACK]` remains optional
- Unsigned research messages rejected with warning

### Phase 3: Full Enforcement (Week 5+)
- All agent messages except `[ACK]` must be signed
- Unsigned messages ignored by other agents
- Human escalation if signature verification fails

---

## Implementation Checklist

- [ ] Generate Ed25519 keypairs for Clawdy and Neuromancer
- [ ] Extend `agents.yaml` with `authentication` section
- [ ] Create `sign_message.py` utility script
- [ ] Create `verify_message.py` utility script
- [ ] Update protocol documentation with signing requirements
- [ ] Test signed message round-trip
- [ ] Test signature verification failure (tampered message)
- [ ] Test key rotation procedure
- [ ] Document emergency revocation process
- [ ] Deploy to production

---

## Security Benefits

| Threat | Before v1.2 | After v1.2 |
|--------|-------------|------------|
| **Impersonation** | Anyone can claim to be any agent | Impossible without private key |
| **Message tampering** | Content can be edited mid-transit | Signature invalidates tampered message |
| **Denial of service** | Spoofed messages consume agent resources | Unsigned/spoofed messages rejected |
| **Non-repudiation** | Agent can deny sending message | Cryptographic proof of origin |

---

## Testing the Authentication Protocol

**Test #4: Authentication Validation (Proposed)**
1. Clawdy signs `[RESEARCH]` message with private key
2. Posts to Matrix
3. Neuromancer receives and verifies signature
4. Neuromancer tampers with message, re-posts
5. Clawdy receives tampered message, detects invalid signature
6. Escalates to human: "Invalid signature detected"

**Success criteria:**
- Valid signatures accepted ✅
- Invalid signatures rejected ✅
- Tampered messages detected ✅

---

## Integration with Git Workflow

**Signed commits (optional enhancement):**
```bash
# Agents sign their Git commits too
git config user.signingkey ~/.agent-mesh/clawdy_key
git commit -S -m "[RESEARCH-TATOOINE] Task #5"

# Verify commit signature
git verify-commit HEAD
```

**Benefit:** Git history also cryptographically verified.

---

## Rollback Plan

**If authentication causes operational issues:**
1. Disable signature verification (accept all messages)
2. Keep signature generation (optional)
3. Debug and fix issues
4. Re-enable verification

**Emergency disable:**
```yaml
# agents.yaml — Emergency override
mesh:
  security:
    authentication_required: false  # Emergency override
```

---

**Status:** Authentication protocol designed, ready for implementation.

**Next:** Generate keypairs, create utility scripts, test end-to-end.
